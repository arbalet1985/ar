<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–í—ã–±–æ—Ä –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html, body {
            width: 100%;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
        }
        body {
            background: #000;
        }
        #map {
            width: 100%;
            height: 100%;
            display: block;
        }
        .controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            min-width: 280px;
            max-width: 90%;
            text-align: center;
        }
        .coordinates {
            margin-bottom: 12px;
            font-size: 14px;
            color: #333;
            font-weight: 500;
            white-space: pre-line;
            line-height: 1.6;
        }
        button {
            background: #0088cc;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            width: 100%;
            transition: background 0.2s;
        }
        button:hover {
            background: #0077b3;
        }
        button:active {
            background: #006699;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="controls">
        <div class="coordinates" id="coords">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã...</div>
        <button onclick="sendLocation()" id="sendBtn" disabled>üìç –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</button>
    </div>

    <script>
        let map, marker, selectedLat, selectedLng;
        
        // Fallback –¥–ª—è Telegram Web App
        const tg = window.Telegram?.WebApp || {
            ready: () => {},
            expand: () => {},
            showAlert: (msg) => alert(msg),
            sendData: (data) => console.log('Data:', data),
            close: () => console.log('Close')
        };
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        tg.ready?.();
        tg.expand?.();

        // –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã
        try {
            map = L.map('map').setView([56.326, 44.002], 12);
            
            // CartoDB —Å–ª–æ–π (–±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫, —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–µ–∑–¥–µ)
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '¬© OpenStreetMap contributors ¬© CARTO',
                maxZoom: 20,
                subdomains: 'abcd'
            }).addTo(map);

            // SVG –º–∞—Ä–∫–µ—Ä
            const customIcon = L.divIcon({
                html: '<svg width="32" height="40" viewBox="0 0 32 40" xmlns="http://www.w3.org/2000/svg"><path d="M16 0C7.2 0 0 7.2 0 16c0 8.8 16 24 16 24s16-15.2 16-24c0-8.8-7.2-16-16-16z" fill="#FF3B30"/><circle cx="16" cy="16" r="6" fill="white"/></svg>',
                iconSize: [32, 40],
                iconAnchor: [16, 40],
                popupAnchor: [0, -40],
                className: 'custom-marker'
            });

            // –ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ
            map.on('click', function(e) {
                selectedLat = e.latlng.lat;
                selectedLng = e.latlng.lng;
                
                if (marker) map.removeLayer(marker);
                marker = L.marker([selectedLat, selectedLng], { icon: customIcon }).addTo(map);
                map.setView([selectedLat, selectedLng], map.getZoom(), { animate: true, duration: 0.5 });
                
                document.getElementById('coords').textContent = 
                    `–®–∏—Ä–æ—Ç–∞: ${selectedLat.toFixed(6)}\n–î–æ–ª–≥–æ—Ç–∞: ${selectedLng.toFixed(6)}`;
                document.getElementById('sendBtn').disabled = false;
            });

            // –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        map.setView([lat, lng], 14);
                        marker = L.marker([lat, lng], { icon: customIcon }).addTo(map);
                        selectedLat = lat;
                        selectedLng = lng;
                        document.getElementById('coords').textContent = 
                            `–®–∏—Ä–æ—Ç–∞: ${lat.toFixed(6)}\n–î–æ–ª–≥–æ—Ç–∞: ${lng.toFixed(6)}`;
                        document.getElementById('sendBtn').disabled = false;
                    },
                    function(error) {
                        console.log('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è:', error);
                        document.getElementById('coords').textContent = '–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–æ—á–∫–∏';
                    }
                );
            } else {
                document.getElementById('coords').textContent = '–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–æ—á–∫–∏';
            }
        } catch (e) {
            document.getElementById('coords').textContent = '–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã';
            console.error(e);
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
        function sendLocation() {
            if (!selectedLat || !selectedLng) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ');
                return;
            }
            const data = { lat: selectedLat, lon: selectedLng };
            const dataStr = JSON.stringify(data);
            
            console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö:', dataStr);
            
            // –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —á–µ—Ä–µ–∑ Telegram Web App
            if (typeof tg.sendData === 'function') {
                try {
                    tg.sendData(dataStr);
                    if (typeof tg.close === 'function') {
                        tg.close();
                    }
                    return;
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —á–µ—Ä–µ–∑ tg.sendData:', e);
                }
            }
            
            // –ï—Å–ª–∏ Telegram API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∫–æ–ø–∏—Ä—É–µ–º –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
            try {
                navigator.clipboard.writeText(dataStr);
                alert(`‚úÖ –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞:\n\n${dataStr}\n\n–ü–µ—Ä–µ–π–¥–∏ –≤ Telegram –±–æ—Ç–∞ –∏ –≤—Å—Ç–∞–≤—å —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ.`);
            } catch (e) {
                alert(`üìç –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:\n–®–∏—Ä–æ—Ç–∞: ${selectedLat.toFixed(6)}\n–î–æ–ª–≥–æ—Ç–∞: ${selectedLng.toFixed(6)}\n\n–û—Ç–ø—Ä–∞–≤—å —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É –≤—Ä—É—á–Ω—É—é.`);
            }
        }

    </script>
</body>
</html>
